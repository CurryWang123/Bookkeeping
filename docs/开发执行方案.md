# 记账系统开发执行方案

## 一、数据库设计（Supabase）

在Supabase SQL编辑器执行以下语句：

```sql
-- 1. 员工表
CREATE TABLE employees (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(50) NOT NULL UNIQUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. 产品表（计件单价）
CREATE TABLE products (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  code VARCHAR(100) NOT NULL,
  name VARCHAR(100) NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. 销售记录表
CREATE TABLE sales_records (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  employee_id BIGINT REFERENCES employees(id),
  product_id BIGINT REFERENCES products(id),
  record_date DATE NOT NULL,
  quantity INTEGER NOT NULL DEFAULT 1,
  unit_price DECIMAL(10,2) NOT NULL,
  total_amount DECIMAL(10,2) NOT NULL,
  is_return BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_sales_date ON sales_records(record_date);
CREATE INDEX idx_sales_employee ON sales_records(employee_id);

-- 初始化员工数据
INSERT INTO employees (name) VALUES
('郭美丽'), ('林连治'), ('廖永丽'), ('周水锦'), ('王雪娥');

-- 初始化产品数据
INSERT INTO products (code, name, price) VALUES
('备菜架', '备菜架', 0.4),
('迷齐边几30', '迷齐边几30', 3),
('迷齐边几35', '迷齐边几35', 3.5),
('迷齐边几40', '迷齐边几40', 4),
('猫头鞋架', '猫头鞋架', 0.5);
```

---

## 二、项目结构调整

```
E:\ideaProject\Bookkeeping\
├── index.html              # 记账主页面（改造）
├── prices.html             # 新增：计件单价页面
├── employees.html          # 新增：人员信息页面
├── js/
│   ├── supabase.js         # Supabase客户端配置
│   ├── db.js               # 数据库操作封装
│   └── app.js              # 主页面逻辑
├── css/
│   └── style.css           # 公共样式
└── docs/                   # 文档目录
```

---

## 三、文件改造/创建清单

| 文件 | 操作 | 说明 |
|------|------|------|
| `js/supabase.js` | 新建 | 初始化Supabase客户端 |
| `js/db.js` | 新建 | 封装CRUD操作 |
| `index.html` | 改造 | 记账页面，姓名/产品改为下拉框 |
| `prices.html` | 新建 | 计件单价管理页面 |
| `employees.html` | 新建 | 人员信息管理页面 |
| `css/style.css` | 新建 | 公共样式 |
| `.env` | 新建 | 环境变量（URL和密钥） |

---

## 四、详细功能改造

### 1. 记账页面（index.html）改造

- 姓名选择：改為 `<select>`，從 employees 表獲取
- 商品编码/产品名称：改為下拉框，支持搜索
- 导出功能：添加月份选择器，按月份筛选导出
- 页面加载：从 Supabase 获取记录列表
- 添加记录：保存到 Supabase
- 删除记录：从 Supabase 删除

### 2. 计件单价页面（prices.html）

**功能：**
- 显示产品列表（编码、名称、单价）
- 支持新增产品（表单输入）
- 支持编辑单价
- 支持删除产品
- 支持 Excel 批量导入

**页面结构：**
- 表格展示产品列表
- 新增产品表单
- 导入按钮

### 3. 人员信息页面（employees.html）

**功能：**
- 显示人员列表
- 支持新增人员
- 支持删除人员

**页面结构：**
- 表格展示人员列表
- 新增人员表单

### 4. 下拉框模糊搜索

使用 `<datalist>` 实现基础模糊搜索：

```html
<input list="products-list" id="product-input">
<datalist id="products-list">
  <!-- 动态从数据库加载 -->
</datalist>
```

---

## 五、开发步骤

| 步骤 | 内容 |
|------|------|
| **1** | 在 Supabase 执行建表 SQL，创建表结构和初始化数据 |
| **2** | 创建项目目录结构（js/css 文件夹） |
| **3** | 创建 `js/supabase.js` 初始化客户端 |
| **4** | 创建 `js/db.js` 封装数据库操作 |
| **5** | 创建 `css/style.css` 公共样式 |
| **6** | 改造 `index.html`：接入 Supabase，姓名/产品改为下拉框 |
| **7** | 创建 `prices.html`：计件单价管理页面 |
| **8** | 创建 `employees.html`：人员信息页面 |
| **9** | 改造导出功能：添加月份选择，按月导出 |
| **10** | 测试所有功能（增删改查、导入导出） |

---

## 六、关键代码结构

### Supabase 客户端（js/supabase.js）

```javascript
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.SUPABASE_URL
const supabaseKey = process.env.SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseKey)
```

### 数据库操作（js/db.js）

```javascript
import { supabase } from './supabase.js'

// 员工操作
export const employees = {
  list: () => supabase.from('employees').select('*').order('name'),
  add: (name) => supabase.from('employees').insert([{ name }]),
  delete: (id) => supabase.from('employees').delete().eq('id', id)
}

// 产品操作
export const products = {
  list: () => supabase.from('products').select('*').order('name'),
  add: (data) => supabase.from('products').insert([data]),
  update: (id, data) => supabase.from('products').update(data).eq('id', id),
  delete: (id) => supabase.from('products').delete().eq('id', id),
  importBatch: (records) => supabase.from('products').upsert(records)
}

// 销售记录操作
export const salesRecords = {
  list: (month) => supabase.from('sales_records').select('*, employees(name), products(name,code)').like('record_date', `${month}%`),
  add: (data) => supabase.from('sales_records').insert([data]),
  delete: (id) => supabase.from('sales_records').delete().eq('id', id)
}
```

---

## 七、Supabase 配置信息

- **URL**: `https://ccivqpgntdotgpswmdnp.supabase.co`
- **Anon Key**: `sb_publishable_jp0yMSee57xUEMPIFKmPVA_BG1qs3s3`

---

## 八、注意事项

1. 页面首次加载时需要从 Supabase 获取员工和产品数据
2. 导出功能按月份筛选，使用 `LIKE` 匹配日期前缀
3. Excel 导入需要解析文件并批量插入到 products 表
4. 建议添加加载状态和错误提示
